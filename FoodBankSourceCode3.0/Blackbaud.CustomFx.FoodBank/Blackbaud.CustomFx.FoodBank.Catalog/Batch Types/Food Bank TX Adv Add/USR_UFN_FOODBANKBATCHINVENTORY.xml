<SQLFunctionSpec
	xmlns="bb_appfx_sqlfunction"
	xmlns:common="bb_appfx_commontypes" 
	ID="827eb177-3161-491b-aaf9-ef21fe402152"
	Name="USR_UFN_FOODBANKBATCHINVENTORY"
	Description="Supports the FoodBankTXBatchVersusCurrentInvReconcile Data List"
	Author="Technical Training"
	DBFunctionName="USR_UFN_FOODBANKBATCHINVENTORY"
	>

	<CreateFunctionSQL>
		<![CDATA[
CREATE FUNCTION [dbo].[USR_UFN_FOODBANKBATCHINVENTORY]
(	
	-- Add the parameters for the function here
	@CONSTITUENTID UNIQUEIDENTIFIER
	, @BATCHID UNIQUEIDENTIFIER
)
RETURNS TABLE
AS
RETURN 
(
	SELECT     BATCHTX.BATCHID
	, BATCHTX.PRIMARYCONTEXTRECORDID AS BATCHTXFOODBANKID
	, FI.ID AS BATCHTXFOODITEMID
	, FI.NAME AS BATCHTXFOODITEMNAME
	, SUM(CASE WHEN BATCHTX.FOODBANKTXTYPECODE = 0 THEN BATCHTXDETAIL.QUANTITY ELSE BATCHTXDETAIL.QUANTITY * - 1 END) AS BATCHTXINV
FROM dbo.USR_BATCHFOODBANKTRANSACTIONADD AS BATCHTX 
INNER JOIN
dbo.USR_BATCHFOODBANKTRANSACTIONADDFOODITEM AS BATCHTXDETAIL ON BATCHTX.ID = BATCHTXDETAIL.BATCHFOODBANKTRANSACTIONADDID 
INNER JOIN
dbo.USR_FOODITEM AS FI ON BATCHTXDETAIL.FOODITEMID = FI.ID
WHERE BATCHTX.PRIMARYCONTEXTRECORDID = @CONSTITUENTID
AND BATCHTX.BATCHID = @BATCHID
GROUP BY BATCHTX.BATCHID, BATCHTX.PRIMARYCONTEXTRECORDID, FI.ID, FI.NAME
)
		]]>
	</CreateFunctionSQL>

</SQLFunctionSpec>
